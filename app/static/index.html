<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Garant√≠as JD Soluciones v3.4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .badge-pendiente { background:#f0ad4e; color:#000; }
      .badge-resuelta { background:#5cb85c; color:#fff; }
      .badge-rechazada { background:#d9534f; color:#fff; }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-3">
      <div class="container-fluid">
        <a class="navbar-brand" href="#" id="navbarBrand">Garant√≠as</a>
        <div class="d-flex">
          <button class="btn btn-light me-2" id="btnExport" style="display:none">üì§ Exportar</button>
          <span id="navUser" class="text-white me-3"></span>
          <button class="btn btn-outline-light" id="btnLogout" style="display:none">Cerrar sesi√≥n</button>
        </div>
      </div>
    </nav>

    <main class="container" id="appGarantias" style="display:none">
      <div class="row">
        <div class="col-md-4">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Registrar nueva garant√≠a</h5>
              <form id="formGarantia">
                <div class="mb-2"><label>Cliente</label><input id="cliente" class="form-control" required></div>
                <div class="mb-2"><label>C√©dula</label><input id="cedula" class="form-control" required></div>
                <div class="mb-2"><label>Tel√©fono</label><input id="telefono" class="form-control" required></div>
                <div class="mb-2"><label>Correo electr√≥nico</label><input id="email" type="email" class="form-control" placeholder="ejemplo@correo.com"></div>
                <div class="mb-2"><label>Tipo de producto</label>
                  <select id="tipo_producto" class="form-control" required>
                    <option value="" disabled selected>Seleccionar...</option>
                    <option value="Portatil">Port√°til</option>
                    <option value="cctv">CCTV</option>
                    <option value="cpu">CPU</option>
                    <option value="monitor">Monitor</option>
                    <option value="otros">Otros</option>
                  </select>
                </div>
                <div class="mb-2" id="tipo_producto_otros_wrap" style="display:none"><label>Especifique el producto</label><input id="tipo_producto_otros" class="form-control" placeholder="Ej: Impresora, Tablet..."></div>
                <div class="mb-2"><label>Marca</label><input id="marca" class="form-control"></div>
                <div class="mb-2"><label>Modelo</label><input id="modelo" class="form-control"></div>
                <div class="mb-2"><label>Serial</label><input id="serial" class="form-control"></div>
                <div class="mb-2"><label>Factura</label><input id="factura" class="form-control"></div>
                <div class="mb-2"><label>Fecha compra</label><input id="fecha_compra" type="date" class="form-control"></div>
                <div class="mb-2"><label>Fallo</label><textarea id="descripcion_falla" class="form-control" required></textarea></div>
                <div class="mb-2"><label>Imagen (opcional)</label><input id="imagen" type="file" class="form-control"></div>
                <button type="submit" class="btn btn-primary">Registrar e Imprimir Recibo</button><span id="msg" class="ms-2"></span>
              </form>
            </div>
          </div>
        </div>
        <div class="col-md-8">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title">Listado de garant√≠as</h5>
                <div class="d-flex">
                  <input type="text" id="buscador" class="form-control form-control-sm me-2" placeholder="Buscar...">
                  <select id="filtroEstado" class="form-select form-select-sm">
                    <option value="">Todos</option>
                    <option value="Recibido">Recibido</option>
                    <option value="En Validacion">En Validaci√≥n</option>
                    <option value="Enviado">Enviado</option>
                    <option value="Esperando Respuesta">Esperando Respuesta</option>
                    <option value="Resuelta">Resuelta</option>
                    <option value="Rechazada">Rechazada</option>
                  </select>
                </div>
              </div>
              <div class="table-responsive" style="max-height:60vh; overflow:auto">
                <table class="table table-striped" id="tablaGarantias">
                  <thead><tr><th>ID</th><th>Cliente</th><th>C√©dula</th><th>Tel√©fono</th><th>Email</th><th>Producto</th><th>Falla</th><th>Estado</th><th>Acciones</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gesti√≥n de Usuarios (solo admin) -->
      <div id="adminPanel" style="display:none">
        <hr>
        <h4>üë• Gesti√≥n de Usuarios</h4>
        <div class="row">
          <div class="col-md-4">
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title">Crear nuevo usuario</h5>
                <form id="formUsuario">
                  <div class="mb-2"><label>Usuario</label><input id="nuevo_username" class="form-control" required></div>
                  <div class="mb-2"><label>Contrase√±a</label><input id="nuevo_password" type="password" class="form-control" required></div>
                  <div class="mb-2"><label>Rol</label>
                    <select id="nuevo_rol" class="form-control" required>
                      <option value="tecnico">T√©cnico</option>
                      <option value="consulta">Consulta</option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-success">Crear Usuario</button>
                  <span id="msgUsuario" class="ms-2"></span>
                </form>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Usuarios del sistema</h5>
                <div class="table-responsive" style="max-height:40vh; overflow:auto">
                  <table class="table table-striped" id="tablaUsuarios">
                    <thead><tr><th>ID</th><th>Usuario</th><th>Rol</th><th>Fecha Creaci√≥n</th><th>Acciones</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        <hr>
        <h4>üè¢ Configuraci√≥n de Empresa</h4>
        <div class="row">
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title">Editar Informaci√≥n</h5>
                <form id="formEmpresa">
                  <div class="mb-2"><label>Nombre Empresa</label><input id="empresa_nombre" class="form-control"></div>
                  <div class="mb-2"><label>Tel√©fono</label><input id="empresa_telefono" class="form-control"></div>
                  <div class="mb-2"><label>Email</label><input id="empresa_email" class="form-control"></div>
                  <div class="mb-2"><label>Direcci√≥n</label><textarea id="empresa_direccion" class="form-control"></textarea></div>
                  <div class="mb-2"><label>Ciudad</label><input id="empresa_ciudad" class="form-control"></div>
                  <div class="mb-2"><label>NIT</label><input id="empresa_nit" class="form-control"></div>
                  <button type="submit" class="btn btn-primary">Actualizar</button>
                  <span id="msgEmpresa" class="ms-2"></span>
                </form>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Subir Logo</h5>
                <form id="formLogo">
                  <div class="mb-2"><input id="logo_file" type="file" class="form-control" accept="image/*" required></div>
                  <button type="submit" class="btn btn-success">Subir Logo</button>
                  <span id="msgLogo" class="ms-2"></span>
                </form>
                <div id="logoPreview" class="mt-2"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Login modal on load -->
    <div class="modal show" id="loginModal" tabindex="-1" style="display:block; background: rgba(0,0,0,0.4)">
      <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Ingresar</h5></div>
          <div class="modal-body">
            <form id="formLogin">
              <div class="mb-2"><label>Usuario</label><input id="login_user" class="form-control" required></div>
              <div class="mb-2"><label>Contrase√±a</label><input id="login_pass" type="password" class="form-control" required></div>
              <div class="d-grid"><button class="btn btn-primary">Entrar</button></div>
              <div id="loginMsg" class="mt-2"></div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Detail modal (hidden) -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Detalle</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div id="detailBody"></div>
            <hr>
            <h6>Comentarios</h6>
            <ul id="comentariosList" class="list-group mb-2"></ul>
            <form id="formComentario" class="mb-2">
              <div class="mb-2"><textarea id="comentario_text" class="form-control" rows="3" placeholder="Agregar comentario..."></textarea></div>
              <div class="mb-2"><input id="comentario_file" type="file" class="form-control"></div>
              <div class="d-flex justify-content-between">
                <select id="cambiar_estado" class="form-select" style="width:200px"><option value="Recibido">Recibido</option><option value="En Validacion">En Validaci√≥n</option><option value="Enviado">Enviado</option><option value="Esperando Respuesta">Esperando Respuesta</option><option value="Resuelta">Resuelta</option><option value="Rechazada">Rechazada</option></select>
                <div><button type="button" id="btnPrintRecibo" class="btn btn-info me-2">üñ®Ô∏è Imprimir Recibo</button><button type="button" id="btnAddComment" class="btn btn-primary me-2">Agregar comentario</button> <button type="button" id="btnChangeState" class="btn btn-secondary">Cambiar estado</button></div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Editar Usuario -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar Usuario</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="formEditUsuario">
              <div class="mb-2">
                <label>Usuario</label>
                <input id="edit_username" class="form-control" required>
              </div>
              <div class="mb-2">
                <label>Nueva Contrase√±a (dejar vac√≠o para mantener actual)</label>
                <input id="edit_password" type="password" class="form-control">
              </div>
              <div class="mb-2">
                <label>Rol</label>
                <select id="edit_rol" class="form-control" required>
                  <option value="consulta">Consulta</option>
                  <option value="tecnico">T√©cnico</option>
                  <option value="admin">Administrador</option>
                </select>
              </div>
              <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary">Actualizar</button>
                <button type="button" id="btnDeleteUser" class="btn btn-danger">Eliminar Usuario</button>
              </div>
              <div id="editUserMsg" class="mt-2"></div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let token = null, usuario=null, rol=null;
      const loginModalEl = document.getElementById('loginModal');
      const detailModalEl = document.getElementById('detailModal');
      const detailModal = new bootstrap.Modal(detailModalEl, { keyboard: true });

      function showSection(name){
        document.getElementById('appGarantias').style.display = (name==='garantias') ? 'block':'none';
      }

      async function api(path, opts={}) {
        opts.headers = opts.headers || {};
        if(token) opts.headers['token'] = token;
        const res = await fetch('/api'+path, opts);
        if(res.status===401){ alert('Sesi√≥n expirada o token inv√°lido'); location.reload(); }
        return res;
      }

      function aplicarNombreEmpresa(nombre){
        const n = (nombre || '').trim() || 'Empresa';
        document.title = 'Garant√≠as - ' + n;
        const brand = document.getElementById('navbarBrand');
        if(brand) brand.textContent = 'Garant√≠as ' + n;
      }

      async function actualizarTituloEmpresa(){
        const res = await api('/configuracion-empresa/nombre');
        if(res.ok){
          try {
            const d = await res.json();
            aplicarNombreEmpresa(d.nombre_empresa);
          } catch(e) { console.warn('actualizarTituloEmpresa:', e); }
        }
      }

      // login
      document.getElementById('formLogin').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const u=document.getElementById('login_user').value, p=document.getElementById('login_pass').value;
        const r=await fetch('/api/login',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u,password:p})});
        if(!r.ok){ document.getElementById('loginMsg').textContent='Credenciales inv√°lidas'; return; }
        const j=await r.json(); token=j.token; usuario=j.username; rol=j.rol;
        sessionStorage.setItem('token',token); sessionStorage.setItem('usuario',usuario); sessionStorage.setItem('rol',rol);
        document.getElementById('navUser').textContent = usuario + ' ('+rol+')';
        document.getElementById('btnLogout').style.display='inline-block';
        document.getElementById('loginModal').style.display='none';
        if(rol==='admin'){ 
          document.getElementById('btnExport').style.display='inline-block';
          document.getElementById('adminPanel').style.display='block';
          cargarUsuarios();
          cargarEmpresaConfig();
        }
        document.getElementById('appGarantias').style.display='block';
        cargarGarantias();
        actualizarTituloEmpresa();
      });

      window.addEventListener('load', ()=>{
        const t=sessionStorage.getItem('token');
        if(t){ token=t; usuario=sessionStorage.getItem('usuario'); rol=sessionStorage.getItem('rol');
          document.getElementById('navUser').textContent = usuario + ' ('+rol+')';
          document.getElementById('btnLogout').style.display='inline-block';
          if(rol==='admin'){ 
            document.getElementById('btnExport').style.display='inline-block';
            document.getElementById('adminPanel').style.display='block';
            cargarUsuarios();
            cargarEmpresaConfig();
          }
          document.getElementById('loginModal').style.display='none';
          document.getElementById('appGarantias').style.display='block';
          cargarGarantias();
          actualizarTituloEmpresa();
        }
      });

      document.getElementById('btnLogout').addEventListener('click', ()=>{ sessionStorage.clear(); location.reload(); });

      // export
      document.getElementById('btnExport').addEventListener('click', async ()=>{
        const res = await api('/garantias/export'); if(!res.ok) return alert('Error al exportar');
        const blob = await res.blob(); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'garantias_export.xlsx'; document.body.appendChild(a); a.click(); a.remove();
      });

      // Mostrar/ocultar campo "Especifique el producto" cuando se elige Otros
      document.getElementById('tipo_producto').addEventListener('change', function(){
        document.getElementById('tipo_producto_otros_wrap').style.display = this.value === 'otros' ? 'block' : 'none';
        document.getElementById('tipo_producto_otros').value = '';
      });

      // create garantia
      document.getElementById('formGarantia').addEventListener('submit', async (e)=>{
        e.preventDefault();
        // Validar campos requeridos
        const cliente = document.getElementById('cliente').value.trim();
        const cedula = document.getElementById('cedula').value.trim();
        const telefono = document.getElementById('telefono').value.trim();
        const tipoProductoSel = document.getElementById('tipo_producto').value;
        const tipoProductoOtros = document.getElementById('tipo_producto_otros').value.trim();
        const tipoProducto = (tipoProductoSel === 'otros' && tipoProductoOtros) ? tipoProductoOtros : tipoProductoSel;
        const descripcionFalla = document.getElementById('descripcion_falla').value.trim();
        
        if (!cliente || !cedula || !telefono || !tipoProducto || !descripcionFalla) {
          alert('Por favor, complete todos los campos obligatorios: Cliente, C√©dula, Tel√©fono, Tipo de producto y Fallo.');
          return;
        }
        
        const fd = new FormData();
        fd.append('cliente', document.getElementById('cliente').value);
        fd.append('cedula', document.getElementById('cedula').value);
        fd.append('telefono', document.getElementById('telefono').value);
        fd.append('email', document.getElementById('email').value);
        fd.append('tipo_producto', tipoProducto);
        fd.append('marca', document.getElementById('marca').value);
        fd.append('modelo', document.getElementById('modelo').value);
        fd.append('serial', document.getElementById('serial').value || '');
        fd.append('factura', document.getElementById('factura').value);
        fd.append('fecha_compra', document.getElementById('fecha_compra').value);
        fd.append('descripcion_falla', document.getElementById('descripcion_falla').value);
        const file = document.getElementById('imagen').files[0]; if(file) fd.append('imagen', file);
        
        const res = await api('/garantias', {method:'POST', body: fd});
        if(res.ok){
          const garantiaData = await res.json();
          alert('Guardado');
          document.getElementById('formGarantia').reset();
          cargarGarantias();
          
          // Siempre imprimir el recibo despu√©s de registrar
          setTimeout(async ()=>{
            try {
              const resPdf = await api(`/garantias/${garantiaData.id}/recibo`);
              if(resPdf.ok){
                const blob = await resPdf.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `recibo_garantia_${garantiaData.id}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
              } else {
                const j = await resPdf.json().catch(()=>({detail:'Error desconocido'}));
                alert(`Error al generar recibo: ${j.detail}`);
              }
            } catch(err){
              console.error('Error al descargar PDF:', err);
              alert('Error al descargar el recibo');
            }
          }, 300);
          
          setTimeout(()=>document.getElementById('msg').textContent='',2000);
        }
        else alert('Error');
      });

      async function cargarGarantias(){
        const res = await api('/garantias'); const data = await res.json();
        const filtro = document.getElementById('filtroEstado').value;
        const search = document.getElementById('buscador').value.toLowerCase();
        const tbody = document.querySelector('#tablaGarantias tbody'); tbody.innerHTML='';
        data.filter(g => {
          if (filtro && g.estado !== filtro) return false;
          if (search) {
            const text = `${g.id} ${g.cliente} ${g.cedula||''} ${g.telefono||''} ${g.email||''} ${g.tipo_producto||''} ${g.marca||''} ${g.modelo||''} ${g.serial||''} ${g.factura||''} ${g.fecha_compra||''} ${g.descripcion_falla||''} ${g.estado}`.toLowerCase();
            if (!text.includes(search)) return false;
          }
          return true;
        }).forEach(g=>{
          const tr = document.createElement('tr');
          let badge = '<span class="badge badge-pendiente">' + (g.estado || 'Recibido') + '</span>';
          if(g.estado==='Resuelta') badge = '<span class="badge badge-resuelta">Resuelta</span>';
          if(g.estado==='Rechazada') badge = '<span class="badge badge-rechazada">Rechazada</span>';
          tr.innerHTML = `<td>${g.id}</td><td>${g.cliente}</td><td>${g.cedula||''}</td><td>${g.telefono||''}</td><td>${g.email||''}</td><td>${g.tipo_producto||''} ${g.marca?' - '+g.marca:''} ${g.modelo?' - '+g.modelo:''} ${g.serial?' - '+g.serial:''}</td><td>${g.descripcion_falla||''}</td><td>${badge}</td><td><button class="btn btn-sm btn-outline-primary" onclick="verDetalle(${g.id})">Ver</button> <button class="btn btn-sm btn-outline-success" onclick="abrirComentario(${g.id})">Comentar</button> <button class="btn btn-sm btn-outline-info" onclick="imprimirRecibo(${g.id})">üñ®Ô∏è</button></td>`;
          tbody.appendChild(tr);
        });
      }

      document.getElementById('filtroEstado').addEventListener('change', cargarGarantias);
      document.getElementById('buscador').addEventListener('input', cargarGarantias);

      // cargar empresa config
      async function cargarEmpresaConfig(){
        const res = await api('/configuracion-empresa');
        if(res.ok){
          const config = await res.json();
          document.getElementById('empresa_nombre').value = config.nombre_empresa || '';
          document.getElementById('empresa_telefono').value = config.telefono || '';
          document.getElementById('empresa_email').value = config.email || '';
          document.getElementById('empresa_direccion').value = config.direccion || '';
          document.getElementById('empresa_ciudad').value = config.ciudad || '';
          document.getElementById('empresa_nit').value = config.nit || '';
          aplicarNombreEmpresa(config.nombre_empresa);
          const preview = document.getElementById('logoPreview');
          if(config.logo_path){
            preview.innerHTML = `<img src="${config.logo_path}" style="max-width:100px; max-height:100px;">`;
          } else {
            preview.innerHTML = 'No hay logo';
          }
        }
      }

      // actualizar empresa
      document.getElementById('formEmpresa').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const data = {
          nombre_empresa: document.getElementById('empresa_nombre').value,
          telefono: document.getElementById('empresa_telefono').value,
          email: document.getElementById('empresa_email').value,
          direccion: document.getElementById('empresa_direccion').value,
          ciudad: document.getElementById('empresa_ciudad').value,
          nit: document.getElementById('empresa_nit').value
        };
        const res = await api('/configuracion-empresa', {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
        if(res.ok){
          aplicarNombreEmpresa(data.nombre_empresa);
          document.getElementById('msgEmpresa').textContent = 'Actualizado';
          setTimeout(()=>document.getElementById('msgEmpresa').textContent='',2000);
        } else {
          const j = await res.json().catch(()=>({detail:'Error desconocido'}));
          document.getElementById('msgEmpresa').textContent = j.detail || 'Error';
        }
      });

      // subir logo
      document.getElementById('formLogo').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData();
        fd.append('logo', document.getElementById('logo_file').files[0]);
        const res = await api('/configuracion-empresa/logo', {method:'POST', body: fd});
        if(res.ok){
          const data = await res.json();
          document.getElementById('msgLogo').textContent = 'Logo subido';
          document.getElementById('logoPreview').innerHTML = `<img src="${data.logo_path}" style="max-width:100px; max-height:100px;">`;
          setTimeout(()=>document.getElementById('msgLogo').textContent='',2000);
        } else {
          const j = await res.json().catch(()=>({detail:'Error'}));
          document.getElementById('msgLogo').textContent = j.detail || 'Error';
        }
      });

      // cargar comentarios
      async function cargarComentarios(gid){
        const rc = await api(`/garantias/${gid}/comentarios`); const comments = await rc.json();
        const clist = document.getElementById('comentariosList'); clist.innerHTML='';
        comments.forEach(c=>{
          const li = document.createElement('li'); li.className='list-group-item';
          li.innerHTML = `<strong>${c.usuario}</strong> <small class="text-muted">${new Date(c.fecha).toLocaleString()}</small><div>${c.texto}</div>${c.attachment_path?`<div><a href='${c.attachment_path}' target='_blank'>Adjunto</a></div>`:''}`;
          clist.appendChild(li);
        });
      }

      // ver detalle (muestra modal una vez)
      async function verDetalle(id){
        const res = await api('/garantias'); const data = await res.json();
        const g = data.find(x=>x.id===id);
        if(!g) return alert('No encontrado');
        document.getElementById('detailBody').innerHTML = `<p><strong>ID:</strong> ${g.id}</p><p><strong>Cliente:</strong> ${g.cliente}</p><p><strong>C√©dula:</strong> ${g.cedula||''}</p><p><strong>Tel√©fono:</strong> ${g.telefono||''}</p><p><strong>Correo:</strong> ${g.email||'‚Äî'}</p><p><strong>Tipo de producto:</strong> ${g.tipo_producto||''}</p><p><strong>Marca:</strong> ${g.marca||''}</p><p><strong>Modelo:</strong> ${g.modelo||''}</p><p><strong>Serial:</strong> ${g.serial||''}</p><p><strong>Falla:</strong> ${g.descripcion_falla||''}</p><p><strong>Estado:</strong> <span id="estadoDetalle">${g.estado}</span></p>${g.imagen_path?`<p><a href='${g.imagen_path}' target='_blank'>Ver imagen</a></p>`:''}`;
        const selEstado = document.getElementById('cambiar_estado');
        selEstado.value = (g.estado && selEstado.querySelector('option[value="'+g.estado+'"]')) ? g.estado : 'Recibido';
        await cargarComentarios(id);
        detailModalEl.dataset.gid = id;
        document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
        detailModal.show();
      }

      // abrirComentario simplemente muestra modal y deja dataset; action handlers son √∫nicos
      function abrirComentario(gid){
        verDetalle(gid);
      }

      // handler √∫nico para agregar comentario
      document.getElementById('btnAddComment').addEventListener('click', async ()=>{
        const gid = detailModalEl.dataset.gid;
        if(!gid) return;
        const txt = document.getElementById('comentario_text').value.trim();
        if(!txt) return alert('Ingrese un comentario');
        const fd = new FormData();
        fd.append('texto', txt);
        const f = document.getElementById('comentario_file').files[0]; if(f) fd.append('archivo', f);
        const res = await api(`/garantias/${gid}/comentarios`, {method:'POST', body: fd});
        if(res.ok){ document.getElementById('comentario_text').value=''; document.getElementById('comentario_file').value=''; await cargarComentarios(gid); cargarGarantias(); } else { const j=await res.json().catch(()=>({detail:'error'})); alert(j.detail||'Error al agregar comentario'); }
      });

      // handler √∫nico para cambiar estado
      document.getElementById('btnChangeState').addEventListener('click', async ()=>{
        const gid = detailModalEl.dataset.gid; if(!gid) return;
        const nuevo = document.getElementById('cambiar_estado').value;
        const fd = new FormData(); fd.append('estado', nuevo);
        const res = await api(`/garantias/${gid}/estado`, {method:'PATCH', body: fd});
        if(res.ok){ document.getElementById('estadoDetalle').innerText = nuevo; cargarGarantias(); } else { const j=await res.json().catch(()=>({detail:'error'})); alert(j.detail||'Error al cambiar estado'); }
      });

      // handler para imprimir recibo
      document.getElementById('btnPrintRecibo').addEventListener('click', async ()=>{
        const gid = detailModalEl.dataset.gid; if(!gid) return;
        try {
          const res = await api(`/garantias/${gid}/recibo`);
          if(res.ok){
            // Crear un blob con el PDF y descargarlo
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `recibo_garantia_${gid}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
          } else {
            const j = await res.json().catch(()=>({detail:'Error desconocido'}));
            alert(`Error al generar recibo: ${j.detail}`);
          }
        } catch (error) {
          alert('Error al descargar el recibo');
        }
      });

      // Funci√≥n para imprimir recibo desde la tabla
      async function imprimirRecibo(gid) {
        try {
          const res = await api(`/garantias/${gid}/recibo`);
          if(res.ok){
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `recibo_garantia_${gid}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
          } else {
            const j = await res.json().catch(()=>({detail:'Error desconocido'}));
            alert(`Error al generar recibo: ${j.detail}`);
          }
        } catch (error) {
          alert('Error al descargar el recibo');
        }
      }

      // Gesti√≥n de Usuarios (solo admin)
      async function cargarUsuarios(){
        const res = await api('/usuarios');
        if(res.ok){
          const users = await res.json();
          const tbody = document.querySelector('#tablaUsuarios tbody');
          tbody.innerHTML = '';
          users.forEach(u => {
            const tr = document.createElement('tr');
            const acciones = u.username === 'admin' ? 
              '<span class="text-muted">Admin principal</span>' : 
              `<button class="btn btn-sm btn-warning me-1" onclick="editarUsuario(${u.id}, '${u.username}', '${u.rol}')">‚úèÔ∏è</button><button class="btn btn-sm btn-danger" onclick="eliminarUsuario(${u.id}, '${u.username}')">üóëÔ∏è</button>`;
            tr.innerHTML = `<td>${u.id}</td><td>${u.username}</td><td>${u.rol}</td><td>${new Date(u.fecha_creacion).toLocaleDateString()}</td><td>${acciones}</td>`;
            tbody.appendChild(tr);
          });
        }
      }

      document.getElementById('formUsuario').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const username = document.getElementById('nuevo_username').value;
        const password = document.getElementById('nuevo_password').value;
        const rol = document.getElementById('nuevo_rol').value;
        
        const res = await api('/usuarios', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({username, password, rol})
        });
        
        const msgEl = document.getElementById('msgUsuario');
        if(res.ok){
          msgEl.innerHTML = '<span class="text-success">Usuario creado exitosamente</span>';
          document.getElementById('formUsuario').reset();
          cargarUsuarios();
        } else {
          const j = await res.json().catch(()=>({detail:'Error desconocido'}));
          msgEl.innerHTML = `<span class="text-danger">${j.detail}</span>`;
        }
      });

      // Funciones de gesti√≥n de usuarios
      function editarUsuario(id, username, rol){
        document.getElementById('edit_username').value = username;
        document.getElementById('edit_password').value = '';
        document.getElementById('edit_rol').value = rol;
        document.getElementById('formEditUsuario').dataset.userId = id;
        new bootstrap.Modal(document.getElementById('editUserModal')).show();
      }

      async function eliminarUsuario(id, username){
        if(!confirm(`¬øEst√°s seguro de eliminar al usuario "${username}"?`)) return;
        
        const res = await api(`/usuarios/${id}`, {method: 'DELETE'});
        if(res.ok){
          alert('Usuario eliminado exitosamente');
          cargarUsuarios();
        } else {
          const j = await res.json().catch(()=>({detail:'Error desconocido'}));
          alert(`Error: ${j.detail}`);
        }
      }

      document.getElementById('formEditUsuario').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const userId = e.target.dataset.userId;
        const username = document.getElementById('edit_username').value;
        const password = document.getElementById('edit_password').value;
        const rol = document.getElementById('edit_rol').value;
        
        const updateData = {username, rol};
        if(password) updateData.password = password;
        
        const res = await api(`/usuarios/${userId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(updateData)
        });
        
        const msgEl = document.getElementById('editUserMsg');
        if(res.ok){
          msgEl.innerHTML = '<span class="text-success">Usuario actualizado exitosamente</span>';
          bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
          cargarUsuarios();
        } else {
          const j = await res.json().catch(()=>({detail:'Error desconocido'}));
          msgEl.innerHTML = `<span class="text-danger">${j.detail}</span>`;
        }
      });
    </script>
  </body>
</html>
